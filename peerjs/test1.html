<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Peerjs call functionality</title>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script src="https://simplewebrtc.com/latest-v2.js"></script>
</head>
<body>
  <h2>Peerjs Mix mp3+mic</h2>
  <h3>Peer ID: <div id="peeriddiv"></div></h3>

  <div>
    <input type="text" id="peerid"></input>
    <button id="callPeerBtn">Call</button>
  </div>

  <br />

  <div>
    <video height="300" id="localVideo" controls autoplay muted></video>
    <video height="300" id="remoteVideo" controls autoplay></video>
    <!--<audio src="http://www.soorsangam.com/tanpura/Kali-1-Csharp-L-M.mp3" autoplay></audio>-->
  </div>

  <script src="getusermedia.bundle.js"></script>
  <script src="attachmediastream.bundle.js"></script>
  <script src="peer_patched.js"></script>
  <script src="webaudioextended.js"></script>
  <script>
    var localStream;
    var remoteStream;
    var mixTracks = true;

    var webAudio = new WebAudioExtended();
    webAudio.start();
    webAudio.loadSound('http://www.soorsangam.com/tanpura/Kali-1-Csharp-L-M.mp3');

    function handleError(error){
      console.log('Error:', error);
    }

    getUserMedia({video: true, audio: true}, function (err, stream) {
        console.log('err', err, stream);
        localStream = stream;
        //attach localStream to localVideo
        attachMediaStream(localStream, document.getElementById('localVideo'));
    });

    var peer = new Peer({key: 'lwjd5qra8257b9'});
    //foimpf1o1rrx80k9
    //var peer = new Peer('peerserver', {host: 'ec2-52-25-140-219.us-west-2.compute.amazonaws.com', port: 9090, path: '/peerserver', proxied: true})
    peer.on('open', function(id){
      console.log('peer id:', id);
      document.getElementById('peeriddiv').innerHTML = id;
    });
    peer.on('call', function(call) {
      // Answer the call, providing our mediaStream
      call.answer(localStream);
      attachMediaStream(localStream, document.getElementById('remoteVideo'));
    });
    document.getElementById('callPeerBtn').onclick = makeCall;

    var call;
    function makeCall(){
      var peerid = document.getElementById('peerid').value;
      call = peer.call(peerid, localStream);
      call.on('stream', answerCall);
    }

    function answerCall(callstream){
      var remoteStreamMixed;
      if(mixTracks){
        remoteStreamMixed = mixFunc(callstream);
      }
      attachMediaStream(remoteStreamMixed, document.getElementById('remoteVideo'));
    }

    function mixFunc(stream){
      if(mixTracks){
        var videoTrackSaved = stream.getVideoTracks()[0];
        var mixedStream = webAudio.applyFilter(stream);
        mixedStream.addTrack(videoTrackSaved);
        webAudio.addEffect();
        return mixedStream;
      } else {
        return stream;
      }

    }

  </script>

</body>
</html>
